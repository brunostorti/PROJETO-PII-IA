rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Regras para a coleção de projetos
    match /projects/{projectId} {
      // Leitura: 
      // - get e list: qualquer usuário autenticado (o código filtra corretamente)
      //   - getProject() é usado principalmente pelo admin (dono)
      //   - list usa arrayContains para filtrar projetos atribuídos
      allow read: if request.auth != null;
      
      // Criação: permitir se usuário autenticado e userId = UID do usuário
      // Verifica se é admin (se documento users/{uid} existir), mas permite mesmo se não existir
      allow create: if request.auth != null 
        && request.resource.data.userId == request.auth.uid
        && (
          // Se documento users/{uid} não existir, permite
          !exists(/databases/$(database)/documents/users/$(request.auth.uid))
          ||
          // Se existir, verifica se é admin
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
        );
      
      // Atualização: dono OU admin (pode atualizar qualquer campo, incluindo assignedUsers)
      allow update: if request.auth != null && (
        request.auth.uid == resource.data.userId ||
        (
          exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
        )
      );
      
      // Delete: somente dono
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // Regras para subcoleção de pontos da obra em um projeto
    match /projects/{projectId}/pontos/{pontoId} {
      // Leitura/Escrita: dono do projeto OU usuário atribuído ao projeto
      allow read, write: if request.auth != null && (
        get(/databases/$(database)/documents/projects/$(projectId)).data.userId == request.auth.uid ||
        request.auth.uid in get(/databases/$(database)/documents/projects/$(projectId)).data.assignedUsers
      )
      // Opcional: garantir que writes respeitem o projectId do path
      && (request.method == 'get' || request.method == 'list' ||
          request.resource.data.projectId == projectId);
    }

    // Configurações por projeto (pesos da comparação, Gemini, etc.)
    match /projects/{projectId}/config/{docId} {
      // Leitura/Escrita: dono do projeto OU usuário atribuído ao projeto
      allow read, write: if request.auth != null && (
        get(/databases/$(database)/documents/projects/$(projectId)).data.userId == request.auth.uid ||
        request.auth.uid in get(/databases/$(database)/documents/projects/$(projectId)).data.assignedUsers
      );
    }
    
    // Regras para a coleção de registros de obras
    match /registros_obras/{registroId} {
      // Leitura: dono do registro OU dono do projeto OU usuário atribuído ao projeto
      allow read: if request.auth != null && (
        request.auth.uid == resource.data.userId ||
        (
          resource.data.projectId != null &&
          (
            get(/databases/$(database)/documents/projects/$(resource.data.projectId)).data.userId == request.auth.uid ||
            request.auth.uid in get(/databases/$(database)/documents/projects/$(resource.data.projectId)).data.assignedUsers
          )
        )
      );
      // Criação: qualquer usuário autenticado pode criar seu próprio registro
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      // Update/Delete: apenas dono do registro
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // Regras para futuras coleções de usuários
    match /users/{userId} {
      // Usuário só pode acessar seus próprios dados
      allow read, write: if request.auth != null 
        && request.auth.uid == userId;

      // Campo de role esperado: 'admin' | 'user'
      // Document example:
      // users/{uid} => { role: 'admin' | 'user', displayName: '...' }
    }
    
    // Regras para a coleção de comparações de imagens (IA)
    match /image_comparisons/{comparisonId} {
      // Leitura: dono da comparação OU dono do projeto OU usuário atribuído ao projeto
      allow read: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        (
          resource.data.projectId != null &&
          (
            get(/databases/$(database)/documents/projects/$(resource.data.projectId)).data.userId == request.auth.uid ||
            request.auth.uid in get(/databases/$(database)/documents/projects/$(resource.data.projectId)).data.assignedUsers
          )
        )
      );
      
      // Criação: usuário só pode criar comparações para si mesmo
      allow create: if request.auth != null 
        && request.resource.data.userId == request.auth.uid;
      
      // Atualização: usuário só pode atualizar suas próprias comparações
      allow update: if request.auth != null 
        && resource.data.userId == request.auth.uid;
      
      // Delete: usuário só pode deletar suas próprias comparações
      allow delete: if request.auth != null 
        && resource.data.userId == request.auth.uid;
    }
    
    // Regras para configuração global do app (Gemini, etc.)
    match /app_config/{docId} {
      // Leitura: qualquer usuário autenticado
      // Escrita: apenas admin
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  }
}

